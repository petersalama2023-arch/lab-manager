<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Lab Prep Manager V3.9 (Live Link)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-nav { background-color: #eff6ff; color: #2563eb; border-right: 3px solid #2563eb; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        /* Loader for initial sync */
        #loader-overlay { position: fixed; inset: 0; background: white; z-index: 100; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        
        /* Disabled input styling */
        input:disabled, textarea:disabled { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; border-color: #e5e7eb; }
        
        /* Checkbox custom style for dashboard */
        .session-checkbox { transform: scale(1.2); cursor: pointer; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

<!-- Initial Loading Screen -->
<div id="loader-overlay">
    <div class="flex flex-col items-center">
        <span class="material-symbols-outlined text-4xl text-blue-600 animate-spin">cloud_sync</span>
        <p class="mt-2 text-sm text-slate-500 font-medium">Syncing Lab Data...</p>
    </div>
</div>

<!-- Header -->
<header class="bg-white border-b border-slate-200 h-16 shrink-0 z-20 shadow-sm flex items-center justify-between px-6">
    <div class="flex items-center gap-3 cursor-pointer" onclick="app.actions.goToDashboard()" title="Go to Dashboard">
        <div class="bg-blue-600 text-white p-1.5 rounded-lg shadow-sm">
            <span class="material-symbols-outlined text-xl">biotech</span>
        </div>
        <div>
            <h1 class="text-sm font-bold text-slate-900 leading-tight">Lab Prep Manager V3.9</h1>
            <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wide">Secure Cloud Dashboard</p>
        </div>
    </div>
    <div class="flex items-center gap-4">
        <!-- Active Session Badge -->
        <div class="hidden flex items-center gap-3 bg-blue-50 px-3 py-1.5 rounded-full border border-blue-100 transition-all" id="activeSessionIndicator">
            <div class="flex flex-col items-end leading-tight">
                <span class="text-[10px] text-blue-400 uppercase font-bold">Active Session</span>
                <span class="text-xs font-bold text-blue-800" id="currentSessionNameDisplay">--</span>
            </div>
            <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
            </span>
        </div>
        
        <button class="flex items-center gap-2 text-slate-600 hover:text-blue-600 transition-colors hidden" id="backToDashBtn" onclick="app.actions.goToDashboard()">
            <span class="material-symbols-outlined">grid_view</span>
            <span class="text-sm font-medium">All Sessions</span>
        </button>

        <div class="h-8 w-px bg-slate-200"></div>
        
        <!-- NEW: Share App Button (Base Link) -->
        <button class="flex items-center gap-2 text-slate-600 hover:text-purple-600 transition-colors group" onclick="app.utils.copyAppUrl()">
            <span class="material-symbols-outlined group-hover:scale-110 transition-transform">link</span>
            <span class="text-sm font-medium">App Link</span>
        </button>

        <!-- Share Session Button (Session Link) -->
        <button class="flex items-center gap-2 text-slate-600 hover:text-green-600 transition-colors group hidden" id="shareSessionBtn" onclick="app.utils.copySessionUrl()">
            <span class="material-symbols-outlined group-hover:scale-110 transition-transform">person_add</span>
            <span class="text-sm font-medium">Invite</span>
        </button>
    </div>
</header>

<div class="flex flex-1 overflow-hidden">
    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 overflow-y-auto z-10">
        <div class="p-4">
            <!-- New Session Button triggers logic to create NEW ID -->
            <button class="w-full bg-slate-900 hover:bg-slate-800 text-white shadow-md hover:shadow-lg py-3 px-4 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-all mb-6" onclick="app.modals.openNewSession()">
                <span class="material-symbols-outlined text-lg">add_circle</span>
                New Session
            </button>
            <div class="opacity-50 pointer-events-none transition-opacity duration-300" id="bufferNav">
                <!-- Media Section -->
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 pl-2">Growth Media</p>
                <nav class="space-y-0.5 mb-6">
                    <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors" data-id="lb" onclick="app.views.loadBuffer('lb')">
                        <span class="material-symbols-outlined text-lg text-lime-600">radio_button_unchecked</span> LB Broth (Miller)
                    </button>
                    <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors" data-id="tb" onclick="app.views.loadBuffer('tb')">
                        <span class="material-symbols-outlined text-lg text-emerald-600">science</span> Terrific Broth (TB)
                    </button>
                    <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors" data-id="2xyt" onclick="app.views.loadBuffer('2xyt')">
                        <span class="material-symbols-outlined text-lg text-indigo-600">grid_view</span> 2xYT Medium
                    </button>
                </nav>
                <!-- Buffers Section -->
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 pl-2">Lysis Buffers</p>
                <nav class="space-y-0.5 mb-6">
                    <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors" data-id="p2" onclick="app.views.loadBuffer('p2')">
                        <span class="material-symbols-outlined text-lg text-orange-500">bolt</span> Buffer P2 (Lysis)
                    </button>
                    <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors" data-id="p1" onclick="app.views.loadBuffer('p1')">
                        <span class="material-symbols-outlined text-lg text-teal-600">water_drop</span> Buffer P1 (Resusp)
                    </button>
                    <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors" data-id="p3" onclick="app.views.loadBuffer('p3')">
                        <span class="material-symbols-outlined text-lg text-rose-500">stop_circle</span> Buffer P3 (Neut)
                    </button>
                    <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors" data-id="stock1" onclick="app.views.loadBuffer('stock1')">
                        <span class="material-symbols-outlined text-lg text-purple-600">science</span> 2M NaOH (Stock 1)
                    </button>
                    <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors" data-id="stock2" onclick="app.views.loadBuffer('stock2')">
                        <span class="material-symbols-outlined text-lg text-amber-500">soap</span> 10% SDS (Stock 2)
                    </button>
                </nav>
            </div>
        </div>
        <div class="mt-auto p-4 border-t border-slate-100 bg-slate-50">
            <div class="flex items-start gap-2 text-xs text-slate-500">
                <span class="material-symbols-outlined text-sm text-blue-500 mt-0.5">lock</span>
                <span><strong>Security:</strong> Saved entries are locked. Admin password required to edit.</span>
            </div>
        </div>
    </aside>
    
    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto bg-slate-50/50 p-6 relative" id="mainContainer">
        <!-- Dashboard (Default View) -->
        <div class="max-w-5xl mx-auto fade-in" id="dashboardView">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-900">Available Sessions</h2>
            </div>
            <div id="sessionList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
                <!-- Session Cards Injected Here -->
                <div class="col-span-full text-center py-12 text-slate-400 flex flex-col items-center">
                    <span class="material-symbols-outlined text-4xl mb-2">manage_search</span>
                    Loading sessions from cloud...
                </div>
            </div>
        </div>
    </main>

    <!-- Bulk Action Bar -->
    <div id="bulkActionBar" class="fixed bottom-0 left-64 right-0 bg-white border-t border-blue-200 shadow-xl p-4 flex justify-between items-center transform translate-y-full transition-transform duration-300 z-40">
        <div class="flex items-center gap-3">
            <div class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-bold border border-blue-200">
                <span id="selectedCount">0</span> Selected
            </div>
            <button onclick="app.actions.clearSelection()" class="text-xs text-slate-500 hover:text-slate-800 underline">Clear</button>
        </div>
        <div class="flex gap-4">
            <!-- Compare Group -->
            <div class="flex items-center gap-2 border-r border-slate-200 pr-4">
                <span class="text-xs font-bold text-slate-400 uppercase mr-1">Comparison</span>
                <button onclick="app.firebaseActions.exportMulti('compare', 'pdf')" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded text-sm flex items-center gap-1 border border-slate-300"><span class="material-symbols-outlined text-sm">picture_as_pdf</span> PDF</button>
                <button onclick="app.firebaseActions.exportMulti('compare', 'excel')" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded text-sm flex items-center gap-1 border border-slate-300"><span class="material-symbols-outlined text-sm">table_view</span> Excel</button>
            </div>
            <!-- Report Group -->
            <div class="flex items-center gap-2">
                <span class="text-xs font-bold text-slate-400 uppercase mr-1">Report (Tabs)</span>
                <button onclick="app.firebaseActions.exportMulti('report', 'pdf')" class="bg-slate-700 hover:bg-slate-800 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1 shadow"><span class="material-symbols-outlined text-sm">picture_as_pdf</span> PDF</button>
                <button onclick="app.firebaseActions.exportMulti('report', 'excel')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm flex items-center gap-1 shadow"><span class="material-symbols-outlined text-sm">table_view</span> Excel</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: New Session -->
<div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4" id="modalOverlay">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md hidden scale-95 transition-transform duration-200" id="newSessionModal">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-bold text-slate-900">Initialize Session</h3>
                <p class="text-sm text-slate-500">Create a new project workspace.</p>
            </div>
            <button class="text-slate-400 hover:text-slate-600" onclick="app.modals.close()"><span class="material-symbols-outlined">close</span></button>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Session Date</label>
                <input class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" id="sessionDate" type="date">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Project Name</label>
                <input class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" id="sessionName" placeholder="e.g. Media Prep - Week 42" type="text">
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Lead Operator Initials</label>
                <input class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none uppercase font-mono" id="sessionOperator" maxlength="3" placeholder="XYZ" type="text">
            </div>
        </div>
        <div class="p-4 bg-slate-50 border-t border-slate-100 rounded-b-xl flex justify-end gap-3">
            <button class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800" onclick="app.modals.close()">Cancel</button>
            <button class="px-4 py-2 text-sm font-bold bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md transition-colors" onclick="app.firebaseActions.createCloudSession()">Create Session</button>
        </div>
    </div>
</div>

<!-- Modal: Deviation Warning -->
<div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4" id="deviationModal">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md scale-100 border-2 border-red-500">
        <div class="p-6 border-b border-slate-100 flex items-center gap-3 bg-red-50 rounded-t-xl">
            <span class="material-symbols-outlined text-red-600 text-2xl">warning</span>
            <div>
                <h3 class="text-lg font-bold text-red-700">Safety Deviation Detected</h3>
                <p class="text-xs text-red-500 font-bold">Variances exceed 5% tolerance.</p>
            </div>
        </div>
        <div class="p-6">
            <p class="text-sm text-slate-600 mb-4">The following ingredients significantly differ from the calculated target. Please review before saving.</p>
            <div id="deviationList" class="bg-slate-50 p-3 rounded border border-slate-200 text-sm space-y-2 mb-4 max-h-40 overflow-y-auto">
                <!-- Errors injected here -->
            </div>
            <div class="flex justify-end gap-3">
                <button class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 border rounded" onclick="document.getElementById('deviationModal').classList.add('hidden')">Cancel & Fix</button>
                <button class="px-4 py-2 text-sm font-bold bg-red-600 text-white rounded hover:bg-red-700 shadow-md" onclick="app.firebaseActions.confirmDeviation()">Acknowledge & Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="fixed bottom-6 right-6 transform translate-y-20 opacity-0 transition-all duration-300 z-50 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3" id="toast">
    <span class="material-symbols-outlined text-green-400" id="toastIcon">check_circle</span>
    <span class="text-sm font-medium" id="toastMsg">Action Successful</span>
</div>

<!-- Application Script -->
<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyBJzaPqZNu5AVgEYKmzgNwQK5kuHqTOLXM",
        authDomain: "lab-manager-e5fde.firebaseapp.com",
        projectId: "lab-manager-e5fde",
        storageBucket: "lab-manager-e5fde.firebasestorage.app",
        messagingSenderId: "935330014496",
        appId: "1:935330014496:web:598696ef00bb789076e345"
    };

    // --- SECURITY CONFIG ---
    const ADMIN_PASSWORD = "lab123";

    // --- INIT FIREBASE ---
    let db, auth;
    let activeSessionUnsubscribe = null;

    try {
        const firebaseApp = initializeApp(firebaseConfig);
        db = getFirestore(firebaseApp);
        auth = getAuth(firebaseApp);
        signInAnonymously(auth).catch(e => console.error("Auth Error", e));
    } catch (e) {
        console.error("Firebase Config Missing or Invalid", e);
        alert("Firebase is not configured. Please open the HTML file and paste your keys.");
    }

    /** * DATA CONFIGURATION */
    const buffersData = {
        stock1: { id: "Stock1", name: "Stock 1: 2 M NaOH", chem: "NaOH", safety: "CORROSIVE", color: "purple", shelfLife: "1 Month", precautions: ["Exothermic reaction.", "Use Plastic (PP/HDPE) containers.", "Airtight seal."], qc: { target: "> 13", unit: "" }, baseVol: 25, ingredients: [{ name: "Milli-Q Water (Initial)", amount: 20, unit: "mL", type: "liquid" }, { name: "NaOH Pellets", amount: 2.0, unit: "g", type: "solid" }, { name: "Milli-Q Water (Top up)", amount: "to Vol", unit: "", type: "fill" }] },
        stock2: { id: "Stock2", name: "Stock 2: 10% SDS", chem: "SDS", safety: "IRRITANT", color: "amber", shelfLife: "3 Months", precautions: ["Wear mask (dust).", "DO NOT VORTEX.", "Heat to 40-50°C to dissolve."], qc: { target: "6.0 - 9.5", unit: "" }, baseVol: 25, ingredients: [{ name: "Milli-Q Water (Initial)", amount: 20, unit: "mL", type: "liquid" }, { name: "SDS Powder", amount: 2.5, unit: "g", type: "solid" }, { name: "Milli-Q Water (Top up)", amount: "to Vol", unit: "", type: "fill" }] },
        p1: { id: "P1", name: "Buffer P1: Resuspension", chem: "Tris-EDTA", safety: "Safe", color: "teal", shelfLife: "1 Month (4°C)", precautions: ["Adjust pH to 8.0 to dissolve EDTA.", "Filter sterilize (0.22 µm)."], qc: { target: "8.0 ± 0.1", unit: "" }, baseVol: 20, ingredients: [{ name: "Milli-Q Water", amount: 15, unit: "mL", type: "liquid" }, { name: "Tris-HCl", amount: 0.158, unit: "g", type: "solid" }, { name: "EDTA Free Acid", amount: 0.058, unit: "g", type: "solid" }, { name: "2M NaOH", amount: "Drops", unit: "", type: "adj" }] },
        p3: { id: "P3", name: "Buffer P3: Neutralization", chem: "K-Acetate", safety: "CORROSIVE", color: "rose", shelfLife: "3 Months (4°C)", precautions: ["Dedicate tools (No P2 cross-contam).", "Rinse pH probe."], qc: { target: "5.5 ± 0.1", unit: "" }, baseVol: 20, ingredients: [{ name: "Milli-Q Water", amount: 10, unit: "mL", type: "liquid" }, { name: "Potassium Acetate", amount: 5.89, unit: "g", type: "solid" }, { name: "Glacial Acetic Acid", amount: "Drops", unit: "", type: "adj" }] },
        p2: { id: "P2", name: "Buffer P2: Lysis", chem: "NaOH/SDS", safety: "FRESH ONLY", color: "orange", shelfLife: "< 15 Mins", precautions: ["Prepare FRESH.", "Invert only (NO VORTEX).", "Check pH > 12.5."], qc: { target: "> 12.5", unit: "" }, baseVol: 10, ingredients: [{ name: "Stock 1 (2M NaOH)", amount: 1.0, unit: "mL", type: "liquid" }, { name: "Stock 2 (10% SDS)", amount: 1.0, unit: "mL", type: "liquid" }, { name: "Milli-Q Water", amount: 8.0, unit: "mL", type: "liquid" }] },
        lb: { id: "LB", name: "LB Broth (Miller)", chem: "Rich Media", safety: "Biohazard Level 1", color: "lime", shelfLife: "Autoclaved", precautions: ["<strong>Step 1:</strong> Measure and add ingredients to ~90% of final volume of Milli-Q water.", "<strong>Step 2:</strong> Stir to dissolve. (Optional: Adjust pH to 7.0).", "<strong>Step 3:</strong> Adjust to final volume.", "<strong>Step 4: Sterilization (Choose One):</strong><br>&bull; <em>Standard:</em> Autoclave at 121°C for 20 mins.<br>&bull; <em>Alternative:</em> Filter sterilize through a 0.22 µm membrane."], qc: { target: "7.0 ± 0.2", unit: "" }, baseVol: 1000, ingredients: [{ name: "Milli-Q Water", amount: 950, unit: "mL", type: "liquid" }, { name: "Tryptone", amount: 10, unit: "g", type: "solid" }, { name: "Yeast Extract", amount: 5, unit: "g", type: "solid" }, { name: "NaCl", amount: 10, unit: "g", type: "solid" }, { name: "Water (Top Up)", amount: "to Vol", unit: "", type: "fill" }] },
        tb: { id: "TB", name: "Terrific Broth (TB)", chem: "Enriched Media", safety: "Biohazard Level 1", color: "emerald", shelfLife: "Autoclaved", precautions: ["<strong>Step 1 (Base):</strong> Dissolve Tryptone, Yeast Ext, and Glycerol in 900mL water.", "<strong>Step 2 (Salts):</strong> Dissolve Phosphates (KH2PO4, K2HPO4) in 100mL water separately.", "<strong>Step 3: Sterilization:</strong> Autoclave OR Filter sterilize BOTH solutions separately.", "<strong>Step 4:</strong> Allow both to cool to < 60°C.", "<strong>Step 5:</strong> Aseptically mix the Salt solution into the Base solution."], qc: { target: "7.2 ± 0.2", unit: "" }, baseVol: 1000, ingredients: [{ name: "Tryptone", amount: 12, unit: "g", type: "solid" }, { name: "Yeast Extract", amount: 24, unit: "g", type: "solid" }, { name: "Glycerol", amount: 5, unit: "g", type: "solid" }, { name: "KH2PO4 (Phosphate Stock)", amount: 2.31, unit: "g", type: "solid" }, { name: "K2HPO4 (Phosphate Stock)", amount: 12.54, unit: "g", type: "solid" }, { name: "Total Water", amount: 1000, unit: "mL", type: "fill" }] },
        "2xyt": { id: "2xYT", name: "2xYT Medium", chem: "Rich Media", safety: "Biohazard Level 1", color: "indigo", shelfLife: "Autoclaved", precautions: ["<strong>Step 1:</strong> Measure and add ingredients to ~90% water.", "<strong>Step 2:</strong> Adjust pH to 7.0. Top up volume.", "<strong>Step 3: Sterilization (Choose One):</strong><br>&bull; <em>Standard:</em> Autoclave at 121°C for 20 mins.<br>&bull; <em>Alternative:</em> Filter sterilize (0.22 µm) if needed."], qc: { target: "7.0 ± 0.2", unit: "" }, baseVol: 1000, ingredients: [{ name: "Milli-Q Water", amount: 950, unit: "mL", type: "liquid" }, { name: "Tryptone", amount: 16, unit: "g", type: "solid" }, { name: "Yeast Extract", amount: 10, unit: "g", type: "solid" }, { name: "NaCl", amount: 5, unit: "g", type: "solid" }, { name: "Water (Top Up)", amount: "to Vol", unit: "", type: "fill" }] }
    };

    // Global App Object
    window.app = {
        state: { 
            activeSession: null, 
            currentBufferKey: null,
            allSessions: [],
            selectedSessions: new Set(),
            unlockedEntryId: null,
            pendingEntry: null
        },
        
        utils: {
            generateId: () => Math.random().toString(36).substr(2, 9),
            getBatchCode: (operator, date, bufferId) => `${operator.toUpperCase()}-${date.replace(/-/g, '')}-${bufferId}`,
            
            showToast: (msg, type = 'success') => {
                const t = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = msg;
                document.getElementById('toastIcon').innerText = type === 'success' ? 'check_circle' : 'error';
                document.getElementById('toastIcon').className = `material-symbols-outlined ${type === 'success' ? 'text-green-400' : 'text-red-400'}`;
                t.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
            },

            copySessionUrl: () => {
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => app.utils.showToast("Link copied! Send it to your team."));
            },

            copyAppUrl: () => {
                const url = window.location.origin + window.location.pathname;
                navigator.clipboard.writeText(url).then(() => app.utils.showToast("App Link Copied!"));
            }
        },

        modals: {
            openNewSession: () => {
                document.getElementById('modalOverlay').classList.remove('hidden');
                document.getElementById('newSessionModal').classList.remove('hidden');
                setTimeout(() => document.getElementById('newSessionModal').classList.replace('scale-95', 'scale-100'), 10);
                document.getElementById('sessionDate').valueAsDate = new Date();
            },
            close: () => {
                document.getElementById('newSessionModal').classList.replace('scale-100', 'scale-95');
                setTimeout(() => {
                    document.getElementById('modalOverlay').classList.add('hidden');
                    document.getElementById('newSessionModal').classList.add('hidden');
                }, 200);
            }
        },

        firebaseActions: {
            loadAllSessions: async () => {
                try {
                    const q = query(collection(db, "sessions"), orderBy("createdAt", "desc"));
                    const querySnapshot = await getDocs(q);
                    app.state.allSessions = [];
                    querySnapshot.forEach((doc) => {
                        app.state.allSessions.push(doc.data());
                    });
                    app.views.renderDashboard();
                } catch(e) {
                    console.error("Error loading session list:", e);
                    document.getElementById('sessionList').innerHTML = `<div class="col-span-full text-center text-red-500">Error loading sessions. Check console.</div>`;
                }
            },

            createCloudSession: async () => {
                const date = document.getElementById('sessionDate').value;
                const name = document.getElementById('sessionName').value;
                const operator = document.getElementById('sessionOperator').value;
                if (!date || !name || !operator) return app.utils.showToast("All fields required", "error");

                const newSessionId = app.utils.generateId();
                const sessionData = { 
                    id: newSessionId, 
                    name, 
                    date, 
                    defaultOperator: operator.toUpperCase(), 
                    entries: [],
                    createdAt: new Date().toISOString()
                };

                try {
                    await setDoc(doc(db, "sessions", newSessionId), sessionData);
                    const url = new URL(window.location);
                    url.searchParams.set('session', newSessionId);
                    window.history.pushState({}, '', url);
                    initSession(newSessionId);
                    app.modals.close();
                    app.utils.showToast("Cloud Session Created");
                } catch (e) {
                    console.error(e);
                    app.utils.showToast("Error saving to cloud", "error");
                }
            },

            prepareEntryForSave: async () => {
                const s = app.state.activeSession;
                if(!s) return;
                
                const b = buffersData[app.state.currentBufferKey];
                if(!document.getElementById('equipCheck').checked) return app.utils.showToast("Confirm protocols followed", "error");
                
                const specificOp = document.getElementById('bufferOperator').value || s.defaultOperator;
                const targetVol = document.getElementById('targetVol').value;
                
                const ingredients = [];
                const deviations = [];

                if(b.id === 'P2') {
                    const i1 = {name: "Stock 1 (2M NaOH)", target: document.getElementById('calc_target_0').innerText, actual: document.getElementById('p2_naoh').value, unit: "mL"};
                    const i2 = {name: "Stock 2 (10% SDS)", target: document.getElementById('calc_target_1').innerText, actual: document.getElementById('p2_sds').value, unit: "mL"};
                    const i3 = {name: "Milli-Q Water", target: document.getElementById('calc_target_2').innerText, actual: document.getElementById('p2_water').value, unit: "mL"};
                    ingredients.push(i1, i2, i3);
                } else {
                     b.ingredients.forEach((ing, idx) => {
                        if(ing.type !== 'fill' && ing.type !== 'adj') {
                            const tVal = document.getElementById(`calc_target_${idx}`).innerText;
                            const aVal = document.getElementById(`ing_input_${idx}`).value;
                            ingredients.push({ name: ing.name, target: tVal, actual: aVal, unit: ing.unit });
                        }
                    });
                }

                ingredients.forEach(ing => {
                    const t = parseFloat(ing.target);
                    const a = parseFloat(ing.actual);
                    if (!isNaN(t) && !isNaN(a)) {
                        const diff = Math.abs((a - t) / t);
                        if (diff > 0.05) { 
                            deviations.push(`${ing.name}: Target ${t} vs Actual ${a} (${(diff*100).toFixed(1)}%)`);
                        }
                    } else {
                        if (t > 0 && isNaN(a)) deviations.push(`${ing.name}: Missing Actual Value`);
                    }
                });

                const existing = s.entries.find(e => e.bufferId === b.id);
                const currentEntryId = existing ? existing.entryId : app.utils.generateId();

                const entry = {
                    entryId: currentEntryId,
                    bufferId: b.id,
                    bufferName: b.name,
                    batchCode: app.utils.getBatchCode(specificOp, s.date, b.id),
                    operator: specificOp.toUpperCase(),
                    targetVol: targetVol,
                    finalVol: document.getElementById('finalVol').value,
                    ph: document.getElementById('measuredPh').value,
                    cond: document.getElementById('measuredCond') ? document.getElementById('measuredCond').value : 'N/A',
                    comments: document.getElementById('comments').value,
                    ingredients: ingredients,
                    shelfLife: b.shelfLife,
                    qcTarget: b.qc.target,
                    timestamp: new Date().toISOString()
                };

                if (deviations.length > 0) {
                    app.state.pendingEntry = entry;
                    const list = document.getElementById('deviationList');
                    list.innerHTML = deviations.map(d => `<div class="text-red-700 font-mono">• ${d}</div>`).join('');
                    document.getElementById('deviationModal').classList.remove('hidden');
                } else {
                    app.firebaseActions.commitSave(entry);
                }
            },

            confirmDeviation: () => {
                if (app.state.pendingEntry) {
                    app.firebaseActions.commitSave(app.state.pendingEntry);
                    document.getElementById('deviationModal').classList.add('hidden');
                    app.state.pendingEntry = null;
                }
            },

            commitSave: async (entry) => {
                const s = app.state.activeSession;
                let updatedEntries = [...s.entries];
                const idx = updatedEntries.findIndex(e => e.bufferId === entry.bufferId);
                if(idx >= 0) updatedEntries[idx] = entry; else updatedEntries.push(entry);

                try {
                    await updateDoc(doc(db, 'sessions', s.id), { entries: updatedEntries });
                    app.utils.showToast("Entry Synced to Cloud");
                    app.state.unlockedEntryId = null;
                    app.views.showSessionManager();
                } catch(e) {
                    console.error(e);
                    app.utils.showToast("Sync Failed", "error");
                }
            },

            // --- EXPORT FUNCTIONALITY (Universal & Detailed) ---
            exportMulti: (mode, format, manualSessions = null) => {
                try {
                    app.utils.showToast(`Generating ${mode.toUpperCase()} ${format.toUpperCase()}...`);
                    
                    let sessionsToExport = [];
                    if (manualSessions) {
                        sessionsToExport = manualSessions;
                    } else {
                        sessionsToExport = app.state.allSessions.filter(s => app.state.selectedSessions.has(s.id));
                    }

                    if (sessionsToExport.length === 0) return app.utils.showToast("No sessions selected", "error");

                    // --- EXCEL GENERATION (XML Spreadsheet 2003 - Universal) ---
                    if (format === 'excel') {
                        let xmlBody = '';
                        
                        if (mode === 'report') {
                            // REPORT MODE: One Tab Per Session
                            sessionsToExport.forEach(s => {
                                let rows = `
                                    <Row><Cell><Data ss:Type="String">Session: ${s.name}</Data></Cell></Row>
                                    <Row><Cell><Data ss:Type="String">Date: ${s.date} | Lead: ${s.defaultOperator}</Data></Cell></Row>
                                    <Row><Cell><Data ss:Type="String"></Data></Cell></Row>
                                    <Row style="font-weight:bold">
                                        <Cell><Data ss:Type="String">Buffer</Data></Cell>
                                        <Cell><Data ss:Type="String">Batch</Data></Cell>
                                        <Cell><Data ss:Type="String">Operator</Data></Cell>
                                        <Cell><Data ss:Type="String">Ingredient</Data></Cell>
                                        <Cell><Data ss:Type="String">Target</Data></Cell>
                                        <Cell><Data ss:Type="String">Actual</Data></Cell>
                                        <Cell><Data ss:Type="String">Status</Data></Cell>
                                        <Cell><Data ss:Type="String">Final Vol</Data></Cell>
                                        <Cell><Data ss:Type="String">pH</Data></Cell>
                                        <Cell><Data ss:Type="String">Cond</Data></Cell>
                                        <Cell><Data ss:Type="String">Comments</Data></Cell>
                                    </Row>
                                `;
                                
                                (s.entries || []).forEach(entry => {
                                    (entry.ingredients || []).forEach((ing, i) => {
                                        let status = "OK";
                                        let cellStyle = "";
                                        const t = parseFloat(ing.target);
                                        const a = parseFloat(ing.actual);
                                        if(!isNaN(t) && !isNaN(a) && Math.abs((a-t)/t) > 0.05) {
                                            status = "DEV > 5%";
                                            cellStyle = 'ss:StyleID="RedBg"'; // Reference defined style below
                                        }
                                        
                                        // Metadata only on first row of ingredient group to keep it clean, or repeat?
                                        // Repeating is safer for filtering.
                                        const vol = entry.finalVol || '';
                                        const ph = entry.ph || '';
                                        const cond = entry.cond || '';
                                        const comments = entry.comments || '';

                                        rows += `
                                            <Row>
                                                <Cell><Data ss:Type="String">${entry.bufferName}</Data></Cell>
                                                <Cell><Data ss:Type="String">${entry.batchCode}</Data></Cell>
                                                <Cell><Data ss:Type="String">${entry.operator}</Data></Cell>
                                                <Cell><Data ss:Type="String">${ing.name}</Data></Cell>
                                                <Cell><Data ss:Type="Number">${t}</Data></Cell>
                                                <Cell><Data ss:Type="Number">${a}</Data></Cell>
                                                <Cell ${cellStyle}><Data ss:Type="String">${status}</Data></Cell>
                                                <Cell><Data ss:Type="String">${vol}</Data></Cell>
                                                <Cell><Data ss:Type="String">${ph}</Data></Cell>
                                                <Cell><Data ss:Type="String">${cond}</Data></Cell>
                                                <Cell><Data ss:Type="String">${comments}</Data></Cell>
                                            </Row>
                                        `;
                                    });
                                    rows += `<Row><Cell><Data ss:Type="String"></Data></Cell></Row>`; // Spacer
                                });

                                xmlBody += `<Worksheet ss:Name="${s.name.replace(/[^a-zA-Z0-9 ]/g, "").substring(0, 30)}"><Table>${rows}</Table></Worksheet>`;
                            });
                        } else {
                            // COMPARE MODE: Group by Buffer Type
                            const grouped = {};
                            sessionsToExport.forEach(s => {
                                (s.entries || []).forEach(e => {
                                    if (!grouped[e.bufferName]) grouped[e.bufferName] = [];
                                    grouped[e.bufferName].push({ ...e, sessionName: s.name, sessionDate: s.date });
                                });
                            });

                            let rows = `<Row><Cell><Data ss:Type="String">HEAD-TO-HEAD COMPARISON</Data></Cell></Row>`;
                            
                            Object.keys(grouped).sort().forEach(bufferName => {
                                rows += `<Row><Cell><Data ss:Type="String"></Data></Cell></Row>`;
                                rows += `<Row><Cell ss:StyleID="Bold"><Data ss:Type="String">BUFFER: ${bufferName}</Data></Cell></Row>`;
                                rows += `
                                    <Row>
                                        <Cell><Data ss:Type="String">Session</Data></Cell>
                                        <Cell><Data ss:Type="String">Date</Data></Cell>
                                        <Cell><Data ss:Type="String">Batch</Data></Cell>
                                        <Cell><Data ss:Type="String">Final Vol</Data></Cell>
                                        <Cell><Data ss:Type="String">pH</Data></Cell>
                                        <Cell><Data ss:Type="String">Cond</Data></Cell>
                                        <Cell><Data ss:Type="String">Operator</Data></Cell>
                                        <Cell><Data ss:Type="String">Comments</Data></Cell>
                                        <Cell><Data ss:Type="String">Deviations?</Data></Cell>
                                    </Row>
                                `;
                                grouped[bufferName].forEach(e => {
                                    // Check if any ingredient had deviation
                                    let hasDev = "No";
                                    let style = "";
                                    (e.ingredients || []).forEach(ing => {
                                        const t = parseFloat(ing.target);
                                        const a = parseFloat(ing.actual);
                                        if(!isNaN(t) && !isNaN(a) && Math.abs((a-t)/t) > 0.05) { hasDev = "YES"; style = 'ss:StyleID="RedBg"'; }
                                    });

                                    rows += `
                                        <Row>
                                            <Cell><Data ss:Type="String">${e.sessionName}</Data></Cell>
                                            <Cell><Data ss:Type="String">${e.sessionDate}</Data></Cell>
                                            <Cell><Data ss:Type="String">${e.batchCode}</Data></Cell>
                                            <Cell><Data ss:Type="Number">${e.finalVol || 0}</Data></Cell>
                                            <Cell><Data ss:Type="Number">${e.ph || 0}</Data></Cell>
                                            <Cell><Data ss:Type="String">${e.cond || ''}</Data></Cell>
                                            <Cell><Data ss:Type="String">${e.operator}</Data></Cell>
                                            <Cell><Data ss:Type="String">${e.comments || ''}</Data></Cell>
                                            <Cell ${style}><Data ss:Type="String">${hasDev}</Data></Cell>
                                        </Row>
                                    `;
                                });
                            });
                            xmlBody = `<Worksheet ss:Name="Comparison"><Table>${rows}</Table></Worksheet>`;
                        }

                        // Generate XML File with styles
                        const template = `<?xml version="1.0"?>
                        <?mso-application progid="Excel.Sheet"?>
                        <Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
                         xmlns:o="urn:schemas-microsoft-com:office:office"
                         xmlns:x="urn:schemas-microsoft-com:office:excel"
                         xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
                         xmlns:html="http://www.w3.org/TR/REC-html40">
                         <Styles>
                          <Style ss:ID="Default" ss:Name="Normal">
                           <Alignment ss:Vertical="Bottom"/>
                           <Borders/>
                           <Font ss:FontName="Arial"/>
                           <Interior/>
                           <NumberFormat/>
                           <Protection/>
                          </Style>
                          <Style ss:ID="Bold">
                           <Font ss:FontName="Arial" ss:Bold="1"/>
                          </Style>
                          <Style ss:ID="RedBg">
                           <Interior ss:Color="#FFC7CE" ss:Pattern="Solid"/>
                           <Font ss:FontName="Arial" ss:Color="#9C0006"/>
                          </Style>
                         </Styles>
                         ${xmlBody}
                        </Workbook>`;
                        
                        const blob = new Blob([template], {type: "application/vnd.ms-excel"}); // MIME type for .xml opening in Excel
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(blob);
                        // Using .xml extension ensures no warning in modern Excel for XML Spreadsheet 2003 format
                        link.download = `Lab_${mode}_${new Date().toISOString().slice(0,10)}.xml`;
                        link.click();
                    }

                    // --- PDF GENERATION ---
                    if (format === 'pdf') {
                        if (!window.jspdf || !window.jspdf.jsPDF) return app.utils.showToast("PDF Lib Error", "error");
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('l', 'mm', 'a4'); // Landscape for more data columns
                        let yPos = 20;

                        if (mode === 'report') {
                            sessionsToExport.forEach((s, idx) => {
                                if (idx > 0) { doc.addPage(); yPos = 20; }
                                
                                doc.setFontSize(16);
                                doc.text(`Session Report: ${s.name}`, 14, yPos);
                                yPos += 8;
                                doc.setFontSize(10);
                                doc.text(`Date: ${s.date} | Lead: ${s.defaultOperator}`, 14, yPos);
                                yPos += 10;

                                (s.entries || []).forEach(entry => {
                                    if (yPos > 180) { doc.addPage(); yPos = 20; }
                                    
                                    doc.setFillColor(230, 230, 230);
                                    doc.rect(14, yPos, 269, 7, 'F'); // Wider for Landscape
                                    doc.setFont("helvetica", "bold");
                                    doc.text(`${entry.bufferName} (${entry.batchCode})`, 16, yPos + 5);
                                    yPos += 10;
                                    
                                    // Metadata Line
                                    doc.setFont("helvetica", "normal");
                                    doc.setFontSize(9);
                                    doc.text(`Final Vol: ${entry.finalVol}mL | pH: ${entry.ph} | Cond: ${entry.cond} | Comments: ${entry.comments || 'None'}`, 16, yPos);
                                    yPos += 5;

                                    const body = (entry.ingredients || []).map(ing => {
                                        const t = parseFloat(ing.target);
                                        const a = parseFloat(ing.actual);
                                        let status = "OK";
                                        if(!isNaN(t) && !isNaN(a) && Math.abs((a-t)/t) > 0.05) status = "DEV > 5%";
                                        return [ing.name, ing.target, ing.unit, ing.actual, status];
                                    });

                                    doc.autoTable({
                                        startY: yPos,
                                        head: [['Ingredient', 'Target', 'Unit', 'Actual', 'Status']],
                                        body: body,
                                        margin: { left: 14, right: 14 },
                                        theme: 'grid',
                                        headStyles: { fillColor: [60, 60, 60] },
                                        columnStyles: { 4: { textColor: [200, 0, 0], fontStyle: 'bold' } } // Highlight deviations red
                                    });
                                    yPos = doc.lastAutoTable.finalY + 10;
                                });
                            });
                        } else {
                            // COMPARE MODE
                            doc.setFontSize(16);
                            doc.text("Head-to-Head Buffer Comparison", 14, yPos);
                            yPos += 15;

                            const grouped = {};
                            sessionsToExport.forEach(s => {
                                (s.entries || []).forEach(e => {
                                    if (!grouped[e.bufferName]) grouped[e.bufferName] = [];
                                    // Calculate Deviation Status for Summary
                                    let devStatus = "OK";
                                    (e.ingredients||[]).forEach(i => {
                                        const t=parseFloat(i.target), a=parseFloat(i.actual);
                                        if(!isNaN(t) && !isNaN(a) && Math.abs((a-t)/t)>0.05) devStatus = "DEV!";
                                    });
                                    
                                    grouped[e.bufferName].push([
                                        s.name, 
                                        s.date, 
                                        e.batchCode, 
                                        e.finalVol, 
                                        e.ph, 
                                        e.cond, 
                                        e.operator,
                                        e.comments || '',
                                        devStatus
                                    ]);
                                });
                            });

                            Object.keys(grouped).sort().forEach(bName => {
                                if (yPos > 180) { doc.addPage(); yPos = 20; }
                                
                                doc.setFontSize(12);
                                doc.setFont("helvetica", "bold");
                                doc.text(`Buffer: ${bName}`, 14, yPos);
                                yPos += 5;

                                doc.autoTable({
                                    startY: yPos,
                                    head: [['Session', 'Date', 'Batch', 'Vol', 'pH', 'Cond', 'Op', 'Notes', 'Status']],
                                    body: grouped[bName],
                                    theme: 'striped',
                                    headStyles: { fillColor: [41, 128, 185] },
                                    styles: { fontSize: 8 },
                                    columnStyles: { 8: { fontStyle: 'bold' } }
                                });
                                yPos = doc.lastAutoTable.finalY + 15;
                            });
                        }
                        
                        doc.save(`Lab_${mode}_${new Date().toISOString().slice(0,10)}.pdf`);
                    }

                } catch(e) {
                    console.error("Multi Export Error", e);
                    app.utils.showToast("Export Failed", "error");
                }
            },

            // Wrapper for single export using the new robust system
            exportExcelSingle: () => app.firebaseActions.exportMulti('report', 'excel', [app.state.activeSession]),
            exportPDFSingle: () => app.firebaseActions.exportMulti('report', 'pdf', [app.state.activeSession]),

            unlockEntry: (entryId) => {
                const pass = prompt("Enter Admin Password to Edit:");
                if(pass === ADMIN_PASSWORD) {
                    app.state.unlockedEntryId = entryId;
                    // Reload view to remove disabled attributes
                    app.views.loadBuffer(app.state.currentBufferKey);
                    app.utils.showToast("Entry Unlocked");
                } else {
                    app.utils.showToast("Incorrect Password", "error");
                }
            }
        },

        actions: {
            toggleSessionSelection: (id) => {
                if (app.state.selectedSessions.has(id)) {
                    app.state.selectedSessions.delete(id);
                } else {
                    app.state.selectedSessions.add(id);
                }
                app.views.updateBulkActionUI();
            },

            clearSelection: () => {
                app.state.selectedSessions.clear();
                // Uncheck all boxes visually
                document.querySelectorAll('.session-checkbox').forEach(cb => cb.checked = false);
                app.views.updateBulkActionUI();
            },

            calculate: (key) => {
                const buffer = buffersData[key];
                const targetVol = parseFloat(document.getElementById('targetVol').value) || 0;
                const ratio = targetVol / buffer.baseVol;

                if(key === 'p2') {
                    const naohVol = (targetVol * 0.1).toFixed(3);
                    const sdsVol = (targetVol * 0.1).toFixed(3);
                    const waterVol = (targetVol * 0.8).toFixed(3);

                    if(document.getElementById('calc_target_0')) {
                        document.getElementById('calc_target_0').innerText = naohVol;
                        document.getElementById('calc_target_1').innerText = sdsVol;
                        document.getElementById('calc_target_2').innerText = waterVol;
                        document.getElementById('p2_validation_box').innerHTML = `
                            <div class="flex flex-col gap-1 text-xs mt-2 p-2 bg-blue-50 text-blue-800 border border-blue-200 rounded">
                                <div class="flex items-center gap-2"><span class="material-symbols-outlined text-sm">verified</span><span class="font-bold">Ratio Check (1:1:8)</span></div>
                                <ul class="ml-6 list-disc"><li>Stock 1: ${naohVol} mL</li><li>Stock 2: ${sdsVol} mL</li><li>Water: ${waterVol} mL</li></ul>
                            </div>`;
                    }
                } else {
                    buffer.ingredients.forEach((ing, idx) => {
                        if(ing.type !== 'fill' && ing.type !== 'adj') {
                            const el = document.getElementById(`calc_target_${idx}`);
                            if(el) el.innerText = parseFloat((ing.amount * ratio).toFixed(3));
                        }
                    });
                }
            },
            
            updateLiveBatchCode: () => {
                 const op = document.getElementById('bufferOperator').value;
                 const s = app.state.activeSession;
                 const bId = buffersData[app.state.currentBufferKey].id;
                 document.getElementById('liveBatchCode').innerText = app.utils.getBatchCode(op, s.date, bId);
            },

            // Navigation Actions
            joinSession: (id, event) => {
                // Prevent join if clicking checkbox area
                if (event && event.target.type === 'checkbox') return;
                
                const url = new URL(window.location);
                url.searchParams.set('session', id);
                window.history.pushState({}, '', url);
                initSession(id);
            },

            goToDashboard: () => {
                const url = new URL(window.location);
                url.searchParams.delete('session');
                window.history.pushState({}, '', url);
                
                app.state.activeSession = null;
                app.state.currentBufferKey = null;
                app.state.unlockedEntryId = null;
                app.state.selectedSessions.clear();
                
                document.getElementById('activeSessionIndicator').classList.add('hidden');
                document.getElementById('backToDashBtn').classList.add('hidden');
                document.getElementById('bufferNav').classList.add('opacity-50', 'pointer-events-none');
                document.getElementById('bulkActionBar').classList.add('translate-y-full'); // Hide bulk bar
                document.getElementById('shareSessionBtn').classList.add('hidden'); // Hide invite btn
                
                if (activeSessionUnsubscribe) {
                    activeSessionUnsubscribe();
                    activeSessionUnsubscribe = null;
                }

                const container = document.getElementById('mainContainer');
                container.innerHTML = `
                    <div class="max-w-5xl mx-auto fade-in" id="dashboardView">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-slate-900">Available Sessions</h2>
                        </div>
                        <div id="sessionList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-20">
                            <div class="col-span-full text-center py-12 text-slate-400 flex flex-col items-center">
                                <span class="material-symbols-outlined text-4xl mb-2 animate-spin">sync</span>
                                Loading...
                            </div>
                        </div>
                    </div>`;
                app.firebaseActions.loadAllSessions();
            }
        },

        ui: {
            updateSessionIndicator: () => {
                const s = app.state.activeSession;
                if(s) {
                    document.getElementById('activeSessionIndicator').classList.remove('hidden');
                    document.getElementById('backToDashBtn').classList.remove('hidden');
                    document.getElementById('shareSessionBtn').classList.remove('hidden'); // Show invite btn
                    document.getElementById('currentSessionNameDisplay').innerText = s.name;
                }
            },
            enableNav: () => document.getElementById('bufferNav').classList.remove('opacity-50', 'pointer-events-none'),
            highlightNav: (id) => document.querySelectorAll('.nav-item').forEach(e => e.classList.toggle('active-nav', e.dataset.id === id))
        },

        views: {
            updateBulkActionUI: () => {
                const count = app.state.selectedSessions.size;
                const bar = document.getElementById('bulkActionBar');
                document.getElementById('selectedCount').innerText = count;
                
                if (count > 0) {
                    bar.classList.remove('translate-y-full');
                } else {
                    bar.classList.add('translate-y-full');
                }
            },

            renderDashboard: () => {
                const container = document.getElementById('sessionList');
                if(!container) return;
                
                if(!app.state.allSessions.length) {
                    container.innerHTML = `<div class="col-span-full text-center py-12 text-slate-400">No sessions found. Start a new one!</div>`;
                    return;
                }
                
                container.innerHTML = app.state.allSessions.map(s => {
                    const isChecked = app.state.selectedSessions.has(s.id) ? 'checked' : '';
                    return `
                    <div class="relative bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow flex flex-col justify-between h-40 group">
                        <div class="absolute top-4 right-4 z-10">
                            <input type="checkbox" class="session-checkbox" ${isChecked} onchange="app.actions.toggleSessionSelection('${s.id}')">
                        </div>
                        <div class="cursor-pointer" onclick="app.actions.joinSession('${s.id}', event)">
                            <div class="flex justify-between items-start mb-2 pr-8">
                                <h3 class="font-bold text-slate-800 text-lg group-hover:text-blue-600 transition-colors truncate">${s.name}</h3>
                            </div>
                            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded font-mono">${s.date}</span>
                            <p class="text-sm text-slate-500 mt-2">Lead: <span class="font-bold">${s.defaultOperator}</span></p>
                        </div>
                        <div class="flex justify-between items-center mt-auto pt-4 border-t border-slate-50 cursor-pointer" onclick="app.actions.joinSession('${s.id}', event)">
                            <span class="text-xs text-slate-400">${s.entries ? s.entries.length : 0} entries</span>
                            <span class="material-symbols-outlined text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity">arrow_forward</span>
                        </div>
                    </div>
                `}).join('');
                
                const loader = document.getElementById('loader-overlay');
                if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500); }
            },

            showSessionManager: () => {
                app.state.currentBufferKey = null;
                app.ui.highlightNav(null);
                const s = app.state.activeSession;
                if(!s) return; 

                const container = document.getElementById('mainContainer');
                
                const listHtml = s.entries.length ? s.entries.map(e => `
                    <div class="bg-white p-4 rounded border border-slate-200 flex justify-between items-center">
                        <div>
                            <div class="font-bold text-slate-800">${e.bufferName}</div>
                            <div class="text-xs text-slate-500 font-mono">${e.batchCode} | Op: ${e.operator}</div>
                        </div>
                        <button onclick="app.views.loadBuffer('${Object.keys(buffersData).find(k => buffersData[k].id === e.bufferId)}')" class="text-blue-600 hover:bg-blue-50 p-2 rounded"><span class="material-symbols-outlined">edit</span></button>
                    </div>
                `).join('') : '<div class="text-center text-slate-400 py-10">No entries yet. Select a buffer from the sidebar to begin.</div>';

                container.innerHTML = `<div class="max-w-4xl mx-auto fade-in"><div class="flex justify-between items-end mb-6"><h2 class="text-2xl font-bold text-slate-900">${s.name} <span class="text-base font-normal text-slate-500">(${s.date})</span></h2><div class="flex gap-2"><button onclick="app.firebaseActions.exportPDFSingle()" class="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded shadow flex items-center gap-2 text-sm"><span class="material-symbols-outlined">picture_as_pdf</span> PDF</button><button onclick="app.firebaseActions.exportExcelSingle()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex items-center gap-2 text-sm"><span class="material-symbols-outlined">table_view</span> Excel</button></div></div><div class="space-y-3">${listHtml}</div></div>`;
            },

            loadBuffer: (key) => {
                app.state.currentBufferKey = key;
                app.ui.highlightNav(key);
                const b = buffersData[key];
                const s = app.state.activeSession;
                const existing = s.entries.find(e => e.bufferId === b.id);
                
                // --- LOCKING LOGIC REFINED ---
                // Locked if: Entry exists AND this specific entry ID is NOT in the unlocked variable
                const isLocked = existing && (app.state.unlockedEntryId !== existing.entryId);
                
                const disabledTag = isLocked ? 'disabled' : '';
                const buttonHtml = isLocked 
                    ? `<button onclick="app.firebaseActions.unlockEntry('${existing.entryId}')" class="bg-amber-600 text-white px-6 py-2 rounded font-bold text-sm shadow hover:bg-amber-700 flex items-center gap-2"><span class="material-symbols-outlined text-sm">lock</span> Unlock to Edit</button>`
                    : `<button onclick="app.firebaseActions.prepareEntryForSave()" class="bg-slate-900 text-white px-6 py-2 rounded font-bold text-sm shadow hover:bg-slate-800">Save Entry</button>`;

                const op = existing ? existing.operator : s.defaultOperator;
                const batchCode = existing ? existing.batchCode : app.utils.getBatchCode(op, s.date, b.id);

                let ingRows = "";
                if(b.id === 'P2') {
                     ingRows = `
                        <div class="grid grid-cols-12 gap-2 py-2 border-b border-slate-100 items-center text-sm">
                            <div class="col-span-5 font-medium">Stock 1 (2M NaOH)</div>
                            <div class="col-span-3 text-right font-mono font-bold text-blue-600" id="calc_target_0">1.0</div>
                            <div class="col-span-4 relative"><input id="p2_naoh" type="number" ${disabledTag} class="w-full border rounded px-2 py-1 pr-8" value="${existing?.ingredients[0].actual||''}"><span class="absolute right-2 top-1.5 text-xs text-slate-400">mL</span></div>
                        </div>
                        <div class="grid grid-cols-12 gap-2 py-2 border-b border-slate-100 items-center text-sm">
                            <div class="col-span-5 font-medium">Stock 2 (10% SDS)</div>
                            <div class="col-span-3 text-right font-mono font-bold text-blue-600" id="calc_target_1">1.0</div>
                            <div class="col-span-4 relative"><input id="p2_sds" type="number" ${disabledTag} class="w-full border rounded px-2 py-1 pr-8" value="${existing?.ingredients[1].actual||''}"><span class="absolute right-2 top-1.5 text-xs text-slate-400">mL</span></div>
                        </div>
                        <div class="grid grid-cols-12 gap-2 py-2 border-b border-slate-100 items-center text-sm">
                            <div class="col-span-5 font-medium">Milli-Q Water</div>
                            <div class="col-span-3 text-right font-mono font-bold text-blue-600" id="calc_target_2">8.0</div>
                            <div class="col-span-4 relative"><input id="p2_water" type="number" ${disabledTag} class="w-full border rounded px-2 py-1 pr-8" value="${existing?.ingredients[2].actual||''}"><span class="absolute right-2 top-1.5 text-xs text-slate-400">mL</span></div>
                        </div>
                        <div id="p2_validation_box"></div>`;
                } else {
                    ingRows = b.ingredients.filter(i => i.type !== 'fill' && i.type !== 'adj').map((ing, i) => `
                        <div class="grid grid-cols-12 gap-2 py-2 border-b border-slate-100 items-center text-sm">
                            <div class="col-span-5 font-medium">${ing.name}</div>
                            <div class="col-span-3 text-right"><span id="calc_target_${i}" class="font-mono font-bold text-blue-600 text-base">${ing.amount}</span><span class="text-xs font-bold text-slate-500 ml-1">${ing.unit}</span></div>
                            <div class="col-span-4 relative"><input id="ing_input_${i}" type="number" step="0.001" ${disabledTag} class="w-full border rounded px-2 py-1 pr-8 text-slate-700" placeholder="Actual" value="${existing?.ingredients[i].actual||''}"><span class="absolute right-2 top-1.5 text-xs text-slate-400 font-bold">${ing.unit}</span></div>
                        </div>`).join('');
                }

                document.getElementById('mainContainer').innerHTML = `
                    <div class="max-w-6xl mx-auto fade-in pb-24">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <div class="flex items-center gap-2 mb-1"><h2 class="text-3xl font-bold text-slate-900">${b.name}</h2><span class="text-xs font-bold px-2 py-1 rounded border bg-${b.color}-50 text-${b.color}-800 border-${b.color}-200">${b.safety}</span></div>
                            </div>
                            <div class="text-right bg-white p-3 border rounded shadow-sm"><div class="text-[10px] text-slate-400 uppercase font-bold">Batch ID</div><div class="font-mono font-bold text-lg" id="liveBatchCode">${batchCode}</div></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            <div class="lg:col-span-4 space-y-4">
                                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Target Volume (mL)</label>
                                    <input type="number" id="targetVol" ${disabledTag} value="${existing?existing.targetVol:b.baseVol}" class="w-full text-3xl font-bold border-b-2 border-blue-200 focus:border-blue-600 outline-none bg-transparent" oninput="app.actions.calculate('${key}')">
                                    <label class="block text-xs font-bold text-slate-500 uppercase mt-4 mb-1">Operator Initials</label>
                                    <input type="text" id="bufferOperator" ${disabledTag} value="${op}" maxlength="3" class="w-full text-lg font-bold uppercase font-mono border-b-2 border-slate-200 focus:border-blue-600 outline-none bg-transparent" oninput="app.actions.updateLiveBatchCode()">
                                </div>
                                <div class="bg-amber-50 border border-amber-200 p-4 rounded-xl text-xs text-amber-900"><strong class="flex items-center gap-1 mb-2"><span class="material-symbols-outlined text-sm">assignment</span> Protocols & Precautions</strong><ul class="list-none space-y-3 leading-relaxed opacity-